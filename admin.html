<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INCRAFT Admin</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #login, #logout {
      padding: 10px 20px;
      background: #0077ff;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      margin: 10px;
    }
    #logout {
      background: #ff4444;
    }

    #admin-panel {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #222;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 480px;
    }

    h2 {
      text-align: center;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 15px 0;
    }

    .toggle-container span {
      font-size: 1.1em;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #666;
      transition: 0.4s;
      border-radius: 30px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px; width: 20px;
      left: 4px; bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #00cc00;
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }
  </style>
</head>
<body>
  <h1>INCRAFT Admin Panel</h1>

  <button id="login">Inicia sessi√≥</button>
  <button id="logout" style="display:none;">Tanca sessi√≥</button>

  <div id="admin-panel" aria-live="polite" aria-atomic="true">
    <h2>Configuraci√≥ del servidor</h2>

    <div class="toggle-container">
      <span>üõ†Ô∏è Mode Manteniment</span>
      <label class="switch">
        <input type="checkbox" id="toggle-maintenance" aria-label="Mode Manteniment" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="toggle-container">
      <span>üí¨ Mostrar bot√≥ de postular</span>
      <label class="switch">
        <input type="checkbox" id="toggle-apply" aria-label="Mostrar bot√≥ de postular" />
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <script>
    const auth0Config = {
      domain: "dev-hlv1jhp4knm0id5b.us.auth0.com",
      clientId: "1FOpkOMjhPMKQiesX8YMzzKDnE3r35e4",
      allowedAdminEmail: "incraft@mail.com"
    };

    let auth0 = null;

    const loginButton = document.getElementById('login');
    const logoutButton = document.getElementById('logout');
    const adminPanel = document.getElementById('admin-panel');
    const maintenanceToggle = document.getElementById('toggle-maintenance');
    const applyToggle = document.getElementById('toggle-apply');

    async function configureAuth() {
      auth0 = await createAuth0Client({
        domain: auth0Config.domain,
        client_id: auth0Config.clientId
      });

      if (window.location.search.includes("code=") &&
          window.location.search.includes("state=")) {
        await auth0.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/admin.html");
      }

      const isAuthenticated = await auth0.isAuthenticated();

      if (isAuthenticated) {
        const user = await auth0.getUser();

        if (user.email === auth0Config.allowedAdminEmail) {
          loginButton.style.display = 'none';
          logoutButton.style.display = 'inline-block';
          adminPanel.style.display = 'block';

          // Carrega estats guardats
          maintenanceToggle.checked = localStorage.getItem('modoMantenimiento') === 'true';
          applyToggle.checked = localStorage.getItem('mostrarPostulacion') === 'true';

          // Guarda els canvis
          maintenanceToggle.onchange = () => {
            localStorage.setItem('modoMantenimiento', maintenanceToggle.checked);
          };
          applyToggle.onchange = () => {
            localStorage.setItem('mostrarPostulacion', applyToggle.checked);
          };

        } else {
          alert("No tens permisos per accedir a aquest panell.");
          await auth0.logout({ logoutParams: { returnTo: window.location.href } });
        }
      } else {
        loginButton.style.display = 'inline-block';
        logoutButton.style.display = 'none';
        adminPanel.style.display = 'none';
      }
    }

    loginButton.addEventListener("click", async () => {
      await auth0.loginWithRedirect({
        authorizationParams: {
          redirect_uri: window.location.href
        }
      });
    });

    logoutButton.addEventListener("click", () => {
      auth0.logout({
        logoutParams: {
          returnTo: window.location.href
        }
      });
    });

    window.onload = configureAuth;
  </script>
</body>
</html>
